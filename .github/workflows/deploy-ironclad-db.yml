name: Deploy IronClad-DB to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'azure/database/ironclad-db/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        working-directory: azure/database/ironclad-db
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/ironclad-db:${{ github.sha }}
          IMAGE_NAME_LATEST=ghcr.io/${{ github.repository_owner }}/ironclad-db:latest
          
          docker build -t $IMAGE_NAME -t $IMAGE_NAME_LATEST .
          docker push $IMAGE_NAME
          docker push $IMAGE_NAME_LATEST
          
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
      
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Get Storage Account key
        id: storage-key
        run: |
          KEY=$(az storage account keys list --resource-group ironclad-rg --account-name ironcladsa --query '[0].value' -o tsv)
          echo "::add-mask::$KEY"
          echo "STORAGE_KEY=$KEY" >> $GITHUB_ENV
      
      - name: Delete existing container instance
        run: |
          az container delete --resource-group ironclad-rg --name ironclad-db-prod --yes || true
      
      - name: Deploy to Azure Container Instances
        run: |
          az container create \
            --resource-group ironclad-rg \
            --name ironclad-db-prod \
            --image ${{ env.IMAGE_NAME }} \
            --registry-login-server ghcr.io \
            --registry-username ${{ github.actor }} \
            --registry-password ${{ secrets.GITHUB_TOKEN }} \
            --cpu 1 \
            --memory 1 \
            --ports 80 \
            --dns-name-label ironclad-db-demo \
            --environment-variables \
              AZURE_STORAGE_ACCOUNT=ironcladsa \
              AZURE_STORAGE_CONTAINER=ironclad-data \
            --secure-environment-variables \
              AZURE_STORAGE_KEY=${{ env.STORAGE_KEY }}
      
      - name: Get container FQDN
        id: container-fqdn
        run: |
          FQDN=$(az container show --resource-group ironclad-rg --name ironclad-db-prod --query 'ipAddress.fqdn' -o tsv)
          echo "Container URL: http://$FQDN"
          echo "FQDN=$FQDN" >> $GITHUB_OUTPUT
      
      - name: Show container logs
        run: |
          sleep 10
          az container logs --resource-group ironclad-rg --name ironclad-db-prod
