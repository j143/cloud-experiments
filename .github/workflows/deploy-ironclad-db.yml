name: Deploy IronClad-DB to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'azure/database/ironclad-db/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ironcladadr
      
      - name: Get ACR credentials
        id: acr-creds
        run: |
          ACR_USERNAME=$(az acr credential show --name ironcladadr --query 'username' -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ironcladadr --query 'passwords[0].value' -o tsv)
          echo "::add-mask::$ACR_PASSWORD"
          echo "username=$ACR_USERNAME" >> $GITHUB_OUTPUT
          echo "password=$ACR_PASSWORD" >> $GITHUB_OUTPUT
      
      - name: Get Storage Account Key
        id: storage-key
        run: |
          STORAGE_KEY=$(az storage account keys list -g ironclad-rg -n ironcladstor --query '[0].value' -o tsv)
          echo "::add-mask::$STORAGE_KEY"
          echo "key=$STORAGE_KEY" >> $GITHUB_OUTPUT
      
      - name: Build and push Docker image
        working-directory: azure/database/ironclad-db
        run: |
          IMAGE_TAG="ironcladadr.azurecr.io/ironclad-db:${{ github.sha }}"
          IMAGE_LATEST="ironcladadr.azurecr.io/ironclad-db:latest"
          
          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST
          
          echo "Built and pushed: $IMAGE_TAG"
          echo "Built and pushed: $IMAGE_LATEST"
      
      - name: Delete existing container instance
        run: |
          az container delete \
            --resource-group ironclad-rg \
            --name ironclad-db-prod \
            --yes || echo "Container instance not found, continuing..."
      
      - name: Deploy to Azure Container Instances
        run: |
          az container create \
            --resource-group ironclad-rg \
            --name ironclad-db-prod \
            --image ironcladadr.azurecr.io/ironclad-db:latest \
            --registry-login-server ironcladadr.azurecr.io \
            --registry-username "${{ steps.acr-creds.outputs.username }}" \
            --registry-password "${{ steps.acr-creds.outputs.password }}" \
            --os-type Linux \
            --cpu 2 \
            --memory 2 \
            --environment-variables \
              AZURE_STORAGE_ACCOUNT=ironcladstor \
              AZURE_STORAGE_KEY="${{ steps.storage-key.outputs.key }}" \
              RUST_LOG=info \
            --ports 8080 \
            --dns-name-label ironclad-db-prod
      
      - name: Get container FQDN
        run: |
          FQDN=$(az container show -g ironclad-rg -n ironclad-db-prod --query ipAddress.fqdn -o tsv)
          echo "Container deployed at: $FQDN"
          echo "Health check: curl http://$FQDN:8080/health"
      
      - name: Show container logs
        run: |
          echo "Waiting for container to start..."
          sleep 10
          echo "Container logs:"
          az container logs -g ironclad-rg -n ironclad-db-prod || echo "Container still starting..."
